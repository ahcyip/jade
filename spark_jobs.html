<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Spark Jobs &mdash; jade 0.7.3 documentation</title>
      <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Singularity Containers" href="singularity_containers.html" />
    <link rel="prev" title="Batch Pipeline" href="pipeline.html" />
    <link href="_static/style.css" rel="stylesheet" type="text/css">

</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="index.html" class="icon icon-home"> jade
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="index.html">Home page</a></li>
<li class="toctree-l1"><a class="reference internal" href="_autosummary/jade.html">API reference</a><ul>
<li class="toctree-l2"><a class="reference internal" href="_autosummary/jade.cli.html">jade.cli</a></li>
<li class="toctree-l2"><a class="reference internal" href="_autosummary/jade.common.html">jade.common</a></li>
<li class="toctree-l2"><a class="reference internal" href="_autosummary/jade.enums.html">jade.enums</a></li>
<li class="toctree-l2"><a class="reference internal" href="_autosummary/jade.events.html">jade.events</a></li>
<li class="toctree-l2"><a class="reference internal" href="_autosummary/jade.exceptions.html">jade.exceptions</a></li>
<li class="toctree-l2"><a class="reference internal" href="_autosummary/jade.extensions.html">jade.extensions</a></li>
<li class="toctree-l2"><a class="reference internal" href="_autosummary/jade.hpc.html">jade.hpc</a></li>
<li class="toctree-l2"><a class="reference internal" href="_autosummary/jade.jobs.html">jade.jobs</a></li>
<li class="toctree-l2"><a class="reference internal" href="_autosummary/jade.loggers.html">jade.loggers</a></li>
<li class="toctree-l2"><a class="reference internal" href="_autosummary/jade.models.html">jade.models</a></li>
<li class="toctree-l2"><a class="reference internal" href="_autosummary/jade.resource_monitor.html">jade.resource_monitor</a></li>
<li class="toctree-l2"><a class="reference internal" href="_autosummary/jade.result.html">jade.result</a></li>
<li class="toctree-l2"><a class="reference internal" href="_autosummary/jade.spark.html">jade.spark</a></li>
<li class="toctree-l2"><a class="reference internal" href="_autosummary/jade.test_common.html">jade.test_common</a></li>
<li class="toctree-l2"><a class="reference internal" href="_autosummary/jade.utils.html">jade.utils</a></li>
<li class="toctree-l2"><a class="reference internal" href="_autosummary/jade.version.html">jade.version</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="installation.html">Installation</a><ul>
<li class="toctree-l2"><a class="reference internal" href="installation.html#computer-or-hpc-with-conda">Computer or HPC with conda</a></li>
<li class="toctree-l2"><a class="reference internal" href="installation.html#computer-with-docker">Computer with docker</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="quickstart.html">Quick Start Guide</a><ul>
<li class="toctree-l2"><a class="reference internal" href="quickstart.html#configure-jobs">Configure Jobs</a></li>
<li class="toctree-l2"><a class="reference internal" href="quickstart.html#submit-jobs">Submit Jobs</a></li>
<li class="toctree-l2"><a class="reference internal" href="quickstart.html#job-status">Job Status</a></li>
<li class="toctree-l2"><a class="reference internal" href="quickstart.html#job-results">Job Results</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="tutorial.html">Tutorial</a><ul>
<li class="toctree-l2"><a class="reference internal" href="tutorial.html#cli-commands">CLI Commands</a></li>
<li class="toctree-l2"><a class="reference internal" href="tutorial.html#hpc-configuration">HPC Configuration</a></li>
<li class="toctree-l2"><a class="reference internal" href="tutorial.html#configure-jobs">Configure Jobs</a></li>
<li class="toctree-l2"><a class="reference internal" href="tutorial.html#cli-execution">CLI Execution</a></li>
<li class="toctree-l2"><a class="reference internal" href="tutorial.html#job-execution">Job Execution</a></li>
<li class="toctree-l2"><a class="reference internal" href="tutorial.html#job-status">Job Status</a></li>
<li class="toctree-l2"><a class="reference internal" href="tutorial.html#canceling-jobs">Canceling Jobs</a></li>
<li class="toctree-l2"><a class="reference internal" href="tutorial.html#job-results">Job Results</a></li>
<li class="toctree-l2"><a class="reference internal" href="tutorial.html#failed-or-missing-jobs">Failed or Missing Jobs</a></li>
<li class="toctree-l2"><a class="reference internal" href="tutorial.html#hpc-job-information">HPC Job information</a></li>
<li class="toctree-l2"><a class="reference internal" href="tutorial.html#debugging">Debugging</a></li>
<li class="toctree-l2"><a class="reference internal" href="tutorial.html#resource-monitoring">Resource Monitoring</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="job_configuration.html">JADE Configuration</a><ul>
<li class="toctree-l2"><a class="reference internal" href="job_configuration.html#main-level">Main Level</a></li>
<li class="toctree-l2"><a class="reference internal" href="job_configuration.html#per-job-definition">Per-Job Definition</a></li>
<li class="toctree-l2"><a class="reference internal" href="job_configuration.html#submission-group-behaviors">Submission Group Behaviors</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="submission_strategies.html">Job Submission Strategies</a><ul>
<li class="toctree-l2"><a class="reference internal" href="submission_strategies.html#independent-short-multi-core-jobs">Independent, short, multi-core jobs</a></li>
<li class="toctree-l2"><a class="reference internal" href="submission_strategies.html#independent-short-single-core-jobs">Independent, short, single-core jobs</a></li>
<li class="toctree-l2"><a class="reference internal" href="submission_strategies.html#independent-single-core-jobs-with-variable-runtimes">Independent, single-core jobs with variable runtimes</a></li>
<li class="toctree-l2"><a class="reference internal" href="submission_strategies.html#jobs-that-require-different-submission-parameters">Jobs that require different submission parameters</a></li>
<li class="toctree-l2"><a class="reference internal" href="submission_strategies.html#jobs-that-require-multiple-nodes">Jobs that require multiple nodes</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="pipeline.html">Batch Pipeline</a><ul>
<li class="toctree-l2"><a class="reference internal" href="pipeline.html#create-the-pipeline">Create the pipeline</a></li>
<li class="toctree-l2"><a class="reference internal" href="pipeline.html#customize-the-config">Customize the config</a></li>
<li class="toctree-l2"><a class="reference internal" href="pipeline.html#submit-the-pipeline">Submit the pipeline</a></li>
<li class="toctree-l2"><a class="reference internal" href="pipeline.html#check-status">Check status</a></li>
<li class="toctree-l2"><a class="reference internal" href="pipeline.html#example">Example</a></li>
</ul>
</li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Spark Jobs</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#setup">Setup</a></li>
<li class="toctree-l2"><a class="reference internal" href="#debugging-problems">Debugging Problems</a></li>
<li class="toctree-l2"><a class="reference internal" href="#compute-node-resource-monitoring">Compute Node Resource Monitoring</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="singularity_containers.html">Singularity Containers</a><ul>
<li class="toctree-l2"><a class="reference internal" href="singularity_containers.html#building-a-container-that-can-be-used-for-hpc-submissions">Building a container that can be used for HPC submissions</a></li>
<li class="toctree-l2"><a class="reference internal" href="singularity_containers.html#running-a-container-that-includes-jade">Running a container that includes JADE</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="distributed_submission.html">Distributed Submission Workflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="advanced_usage.html">Advanced Usage</a><ul>
<li class="toctree-l2"><a class="reference internal" href="advanced_usage.html#extending-jade">Extending JADE</a></li>
<li class="toctree-l2"><a class="reference internal" href="advanced_usage.html#generic-command-extension">Generic Command Extension</a></li>
<li class="toctree-l2"><a class="reference internal" href="advanced_usage.html#demo-extension">Demo Extension</a></li>
<li class="toctree-l2"><a class="reference internal" href="advanced_usage.html#post-process">Post-process</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Dev &amp; Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="jade.html">jade</a><ul class="simple">
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="design.html">JADE Design</a><ul>
<li class="toctree-l2"><a class="reference internal" href="design/classes.html">JADE Classes</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="build_docs.html">Building the Documentation</a><ul>
<li class="toctree-l2"><a class="reference internal" href="build_docs.html#build-locally">Build locally</a></li>
<li class="toctree-l2"><a class="reference internal" href="build_docs.html#push-to-github">Push to GitHub</a></li>
</ul>
</li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">jade</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
      <li>Spark Jobs</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/spark_jobs.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="spark-jobs">
<h1>Spark Jobs<a class="headerlink" href="#spark-jobs" title="Permalink to this headline">¶</a></h1>
<p>JADE has functionality to create an ephemeral Spark cluster on HPC compute nodes and then run a
job on that cluster.</p>
<p><strong>Prerequisite</strong>: The Spark software must be installed inside a Singularity container.</p>
<section id="setup">
<h2>Setup<a class="headerlink" href="#setup" title="Permalink to this headline">¶</a></h2>
<ol class="arabic simple">
<li><p>Create a Docker container with Spark installed. Here is an <a class="reference external" href="https://github.com/dsgrid/dsgrid/blob/main/Dockerfile">example</a>.</p></li>
<li><p>Convert that container to Singularity and copy the image to the HPC’s shared file system.</p></li>
<li><p>Follow the normal steps to create your Jade configuration, such as with <code class="docutils literal notranslate"><span class="pre">jade</span> <span class="pre">config</span> <span class="pre">create</span>
<span class="pre">commands.txt</span></code>. The commands should be the scripts that you want to run against the Spark
cluster including any command-line arguments. <strong>Note</strong>: Jade will append two positional
arguments to your command line arguments: the spark cluster (spark://&lt;node_name&gt;:7077) and the
job output directory.</p></li>
<li><p>Create your HPC config file with <code class="docutils literal notranslate"><span class="pre">jade</span> <span class="pre">config</span> <span class="pre">hpc</span> <span class="pre">-c</span> <span class="pre">hpc_config.toml</span></code>. Set <code class="docutils literal notranslate"><span class="pre">nodes</span></code> in
<code class="docutils literal notranslate"><span class="pre">hpc_config.toml</span></code> to be the number of compute nodes you want to participate in the Spark
cluster. Spark will perform poorly if its scratch file space is on slow storage. You should
specify requirements here that give you nodes with fast internal storage. On NREL’s Eagle
HPC cluster that is only the big-memory and CPU nodes. Alternatively, you can use nodes’ tmpfs
for scratch space as described below.</p></li>
<li><p>Run the command below to update the configuration with Spark parameters. Refer to <code class="docutils literal notranslate"><span class="pre">--help</span></code> for
additional options. This will produce spark configuration files in <code class="docutils literal notranslate"><span class="pre">./spark/conf</span></code> that you
can customize. One possible customization is <code class="docutils literal notranslate"><span class="pre">spark.sql.shuffle.partititons</span></code> and
<code class="docutils literal notranslate"><span class="pre">spark.default.parallelism</span></code> in <code class="docutils literal notranslate"><span class="pre">spark/conf/spark-defaults.conf</span></code>. Jade sets them to the total
number of cores in the cluster by default. Refer to Spark documentation for help with the
parameters.</p></li>
</ol>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ jade config spark -c &lt;path-to-container&gt; -h hpc_config.toml --update-config-file=config.json
</pre></div>
</div>
<ol class="arabic simple" start="6">
<li><p>If you set a custom memory requirement in your <code class="docutils literal notranslate"><span class="pre">hpc_config.toml</span></code> then Jade will increase the
<code class="docutils literal notranslate"><span class="pre">spark.executor.memory</span></code> value in <code class="docutils literal notranslate"><span class="pre">spark/conf/spark-defaults.conf</span></code>. The default value is
intended to maximize memory for 7 executors on each compute node. Customize as needed.</p></li>
<li><p>View the changes to your <code class="docutils literal notranslate"><span class="pre">config.json</span></code> if desired.</p></li>
<li><p>If you are using compute nodes with slow internal storage, consider setting <code class="docutils literal notranslate"><span class="pre">use_tmpfs_for_scratch</span></code>
to true. Note that this reduces availabe worker memory by half and you’ll need to adjust
<code class="docutils literal notranslate"><span class="pre">spark.executor.memory</span></code> accordingly. You can set the option in <code class="docutils literal notranslate"><span class="pre">config.json</span></code> or by passing
<code class="docutils literal notranslate"><span class="pre">-U</span></code> to the <code class="docutils literal notranslate"><span class="pre">jade</span> <span class="pre">config</span> <span class="pre">spark</span></code> command.</p></li>
<li><p>Consider whether you want your jobs to be run inside or outside the container (default is inside).
Jade will run each job outside the container if the <code class="docutils literal notranslate"><span class="pre">run_user_script_outside_container</span></code> option is
set to true. You can set the option for each job in <code class="docutils literal notranslate"><span class="pre">config.json</span></code> or by passing <code class="docutils literal notranslate"><span class="pre">-r</span></code> to
the <code class="docutils literal notranslate"><span class="pre">jade</span> <span class="pre">config</span> <span class="pre">spark</span></code> command. If you do run your script outside of the container, Jade will
still set Spark environment variables to point to your local, customizable Spark config
directory.</p></li>
<li><p>Set <code class="docutils literal notranslate"><span class="pre">collect_worker_logs</span></code> to true if your jobs are getting logs of errors. These can grow large.</p></li>
<li><p>Submit the jobs with <code class="docutils literal notranslate"><span class="pre">jade</span> <span class="pre">submit-jobs</span> <span class="pre">config.json</span></code>. Jade will create a new cluster for each
job, running them sequentially.</p></li>
</ol>
</section>
<section id="debugging-problems">
<h2>Debugging Problems<a class="headerlink" href="#debugging-problems" title="Permalink to this headline">¶</a></h2>
<p>Jade stores Spark logs, events, and metrics in <code class="docutils literal notranslate"><span class="pre">&lt;output-dir&gt;/job-outputs/&lt;job-id&gt;/spark</span></code>.</p>
<p>You can browse the job details in the Spark UI by starting a Spark history server pointed to one
of the job output directories. You can do this on your local computer or on the HPC. If you do it
on the HPC then you’ll need to create an ssh tunnel to the compute node and forward the port 18080.</p>
<p>Here is an example where the files are on your local system:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ SPARK_HISTORY_OPTS=&quot;-Dspark.history.fs.logDirectory=output/job-outputs/1/spark/events&quot; $SPARK_HOME/sbin/start-history-server.sh
</pre></div>
</div>
<p>Load the Spark UI by opening your browser to <a class="reference external" href="http://localhost:18080">http://localhost:18080</a></p>
</section>
<section id="compute-node-resource-monitoring">
<h2>Compute Node Resource Monitoring<a class="headerlink" href="#compute-node-resource-monitoring" title="Permalink to this headline">¶</a></h2>
<p>It can be very helpful to collect CPU, memory, disk, and network resource utilization statistics
for all compute nodes. Refer to <a class="reference internal" href="tutorial.html#resource-monitoring"><span class="std std-ref">Resource Monitoring</span></a> for how to configure Jade to do this for
you.</p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="pipeline.html" class="btn btn-neutral float-left" title="Batch Pipeline" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="singularity_containers.html" class="btn btn-neutral float-right" title="Singularity Containers" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2021, NREL.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>